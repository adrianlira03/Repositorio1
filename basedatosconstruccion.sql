---ESTA BASE DE DATOS VA SOBRE UNA EMPRESA DE CONSTRUCCION QUE QUIERE TENER LA INFORMACION DE LAS OBRAS Y DE SUS TRABAJADORES Y LOS CLIENTES,EN ESTA EMPRESA HAY DOS JEFES.
---Y A CADA UNO DE LOS JEFES SE LE ASIGNA UNA SERIE DE OBRAS, CLIENTES Y TRABAJADORES EN UNA OBRA MANDA EL JEFE Y UN CAPATAZ QUE ES EL QUE ESTA TRABAJNDO ALLI,
---UN CAPATAZ ESTA AL MANDO DE LOS OFICIALES Y LOS OFICIALES ESTAN AL MANDO DE LOS PEONES
---UN CLIENTE PUEDE TENER MUCHAS OBRAS PERO UNA OBRA SOLO PUEDE SER DE UN CLIENTE
---UN CAPATAZ PUEDE TENER MUCHOS OFICIALES PERO UN OFICIAL SOLO PUEDE TENER UN CAPATAZ
---UN JEFE PUEDE TENER MUCHOS CAPATACES PERO UN CAPATAZ SOLO PUEDE TENER UN JEFE
---UN OFICIAL PUEDE TENER MUCHOS PEONES PERO UN PEON SOLO PUEDE TENER UN OFICIAL.
--- UN JEFE Y UN CAPATAZ PUEDEN TENER MUCHAS OBRAS PERO UNA OBRA SOLO PUEDE TENER UN JEFE  Y UN CAPATAZ

DROP TABLE JEFE CASCADE CONSTRAINTS;
DROP TABLE CLIENTE CASCADE CONSTRAINTS;
DROP TABLE OFICIAL CASCADE CONSTRAINTS;
DROP TABLE OBRA CASCADE CONSTRAINTS;
DROP TABLE PEON CASCADE CONSTRAINTS;
DROP TABLE CAPATAZ CASCADE CONSTRAINTS;





CREATE TABLE JEFE
(
NIF VARCHAR2(9) CONSTRAINT JEF_NIF_PK PRIMARY KEY,
NOMBRE VARCHAR2(15) NOT NULL,
APELLIDO1 VARCHAR2(20) NOT NULL,
APELLIDO2 VARCHAR2(15),
NUM_CAPATACES NUMBER(4) 
);

CREATE TABLE CLIENTE 
(
NIF VARCHAR2(9) CONSTRAINT CLI_NIF_PK PRIMARY KEY,
NOMBRE VARCHAR2(15) NOT NULL,
APELLIDO1 VARCHAR2(20),
DIRECCION VARCHAR2(20) CONSTRAINT CLI_DIR_UK UNIQUE,
NIF_JEFE VARCHAR2(9) CONSTRAINT CLIE_NIF_FK REFERENCES JEFE
);



CREATE TABLE CAPATAZ
(
NIF VARCHAR2(9) CONSTRAINT CAP_NIF_PK PRIMARY KEY ,
NOMBRE VARCHAR2(15) NOT NULL,
APELLIDO1 VARCHAR2(20) NOT NULL,
APELLIDO2 VARCHAR2(15),
SUELDO NUMBER(4) DEFAULT 2200,
NIF_JEFE VARCHAR2(9) CONSTRAINT CAP_NIJ_FK REFERENCES JEFE

);

CREATE TABLE OBRA
(
COD NUMBER(6) CONSTRAINT OBR_COD_PK PRIMARY KEY,
DESCRIPCION VARCHAR2(100),
PRESUPUESTO NUMBER (8),
NIF_JEFE VARCHAR2(9) CONSTRAINT OBR_NIJ_FK REFERENCES JEFE,
NIF_CAPATAZ VARCHAR2(9) CONSTRAINT OBR_NIC_FK REFERENCES CAPATAZ,
NIF_CLIENTE VARCHAR2(9) CONSTRAINT OBR_NIL_FK REFERENCES CLIENTE
);

CREATE TABLE OFICIAL 
(
NIF VARCHAR2(9) CONSTRAINT OFI_NIF_PK PRIMARY KEY,
NOMBRE VARCHAR2(15) NOT NULL,
APELLIDO1 VARCHAR2(15) NOT NULL,
APELLIDO2 VARCHAR2(15),
NIF_CAPATAZ VARCHAR2(9) CONSTRAINT OFI_NIC_FK REFERENCES CAPATAZ,
SUELDO NUMBER(4) DEFAULT 1800 
);



CREATE TABLE PEON 
(

NIF VARCHAR2(9) CONSTRAINT PEO_NIF_PK PRIMARY KEY,
NOMBRE VARCHAR2(15) NOT NULL,
APELLIDO1 VARCHAR2(15) NOT NULL,
APELLIDO2 VARCHAR2(15),
NIF_OFICIAL VARCHAR2(9) CONSTRAINT PEO_NIF_FK REFERENCES OFICIAL
);


ALTER TABLE CAPATAZ ADD CONSTRAINT CAP_SUE_CK CHECK (SUELDO BETWEEN 1700 AND 2300);
ALTER TABLE PEON ADD SUELDO NUMBER(4);
ALTER TABLE PEON ADD CONSTRAINT PEO_SUE_CK CHECK (SUELDO BETWEEN 950 AND 1500);
ALTER TABLE OFICIAL  ADD  CONSTRAINT OFI_SUE_CK CHECK (SUELDO BETWEEN 1400 AND 1950);







INSERT INTO JEFE VALUES('28457415G','Juan','Gomez', 'Bernal',5);
INSERT INTO JEFE VALUES('47854157H', 'Nuria',' Vazquez', 'Nuñez', 7);

INSERT INTO CLIENTE VALUES('15745654J','Maria','Lopez', 'C/ Alberche nº3','28457415G');
INSERT INTO CLIENTE VALUES('85471254P','Luis','Ruiz', 'Av.La Palmera nº10','28457415G');
INSERT INTO CLIENTE VALUES('75214875L','Pablo','Garcia', 'C/  Umbria nº54','47854157H');
INSERT INTO CLIENTE VALUES('45248745K','Lucia','Lora', 'C/ Playa nº9','28457415G');
INSERT INTO CLIENTE VALUES('78541268T','Paula','Espinola', 'Av. Alcalde nº26','47854157H');
INSERT INTO CLIENTE VALUES('24785965T','Isaac','Rodriguez', 'C/ Estrella nº4','47854157H');

 
INSERT INTO CAPATAZ VALUES('65214524K','Laura','Lora', 'Garcia',2200,'28457415G');
INSERT INTO CAPATAZ VALUES('63241589J','Julio','Ruiz', 'Conde',2250,'28457415G');
INSERT INTO CAPATAZ VALUES('12457896M','Luis','Vasco','Calvo', 2100,'47854157H');
INSERT INTO CAPATAZ VALUES('95647812D','Estrella','Rodriguez', 'Conde',2150,'47854157H');


INSERT INTO OBRA VALUES(254, 'Lenvantar Chalet', 256300, '47854157H','95647812D', '85471254P');
INSERT INTO OBRA VALUES(364, 'hacer segunda planta ', 90000, '47854157H','63241589J', '45248745K');

INSERT INTO OFICIAL VALUES('25478126J', 'Luis', 'Lopez', 'Conde', '65214524K', 1900);
INSERT INTO OFICIAL VALUES('85278126L', 'Carlos', 'Ruiz', 'Ortiz', '63241589J', 1920);
INSERT INTO OFICIAL VALUES('47512547F', 'Pablo', 'Nuñez', 'Perez', '65214524K', 1800);
INSERT INTO OFICIAL VALUES('94521478T', 'Rafael', 'Lora', 'Sayago', '95647812D', 1900);
INSERT INTO OFICIAL VALUES('68745214N', 'Saul', 'Cardeno', 'Tirado', '65214524K', 1700);
INSERT INTO OFICIAL VALUES('32548741Q', 'Pedro', 'Poden', 'Vietn', '63241589J', 1850);


INSERT INTO PEON VALUES('59874514G', 'Hugo', 'Lucas', 'Palomar', '25478126J', 1300);
INSERT INTO PEON VALUES('45781236J', 'Jose', 'Olmo', 'Garcia', '85278126L', 1350);
INSERT INTO PEON VALUES('25412541L', 'Fernando', 'Bernal', 'Perez', '68745214N',1250);




CREATE  OR REPLACE PROCEDURE VEROFICIAL(DNI VARCHAR2)
IS
REGISTRO OFICIAL%ROWTYPE;
BEGIN
SELECT * INTO REGISTRO FROM OFICIAL  WHERE DNI=NIF;
DBMS_OUTPUT.PUT_LINE ('NIF: ' || REGISTRO.NIF);
DBMS_OUTPUT.PUT_LINE ('NOMBRE: ' || REGISTRO.NOMBRE);
DBMS_OUTPUT.PUT_LINE ('APELLIDO1: ' || REGISTRO.APELLIDO1);
DBMS_OUTPUT.PUT_LINE ('APELLIDO2: ' || REGISTRO.APELLIDO2);
DBMS_OUTPUT.PUT_LINE ('NIF_CAPATAZ ' || REGISTRO.NIF_CAPATAZ);
DBMS_OUTPUT.PUT_LINE ('SUELDO: ' || REGISTRO.SUELDO);
DBMS_OUTPUT.PUT_LINE (' ---- ');
EXCEPTION
WHEN NO_DATA_FOUND THEN
DBMS_OUTPUT.PUT_LINE ('NO SE HA ENCONTRADO EL DNI DEL OFICIAL');
END VEROFICIAL;
/

CREATE  OR REPLACE PROCEDURE VERCAPATAZ (DNI VARCHAR2) IS
REGISTRO CAPATAZ%ROWTYPE;
BEGIN
SELECT * INTO REGISTRO FROM  CAPATAZ WHERE DNI=NIF ;
DBMS_OUTPUT.PUT_LINE ('NIF: ' || REGISTRO.NIF);
DBMS_OUTPUT.PUT_LINE ('NOMBRE: ' || REGISTRO.NOMBRE);
DBMS_OUTPUT.PUT_LINE ('APELLIDO1: ' || REGISTRO.APELLIDO1);
DBMS_OUTPUT.PUT_LINE ('APELLIDO2: ' || REGISTRO.APELLIDO2);
DBMS_OUTPUT.PUT_LINE ('NIF_JEFE: ' || REGISTRO.NIF_JEFE);
DBMS_OUTPUT.PUT_LINE ('SUELDO: ' || REGISTRO.SUELDO);
DBMS_OUTPUT.PUT_LINE (' ---- ');
EXCEPTION
WHEN NO_DATA_FOUND THEN
DBMS_OUTPUT.PUT_LINE ('NO SE HA ENCONTRADO EL DNI DEL CAPATAZ');
END VERCAPATAZ;
/


CREATE  OR REPLACE PROCEDURE VERPEON(DNI VARCHAR2)
IS
REGISTRO PEON%ROWTYPE;
BEGIN
SELECT * INTO REGISTRO FROM PEON WHERE DNI=NIF;
DBMS_OUTPUT.PUT_LINE ('NIF: ' || REGISTRO.NIF);
DBMS_OUTPUT.PUT_LINE ('NOMBRE: ' || REGISTRO.NOMBRE);
DBMS_OUTPUT.PUT_LINE ('APELLIDO1: ' || REGISTRO.APELLIDO1);
DBMS_OUTPUT.PUT_LINE ('APELLIDO2: ' || REGISTRO.APELLIDO2);
DBMS_OUTPUT.PUT_LINE ('NIF_JEFE: ' || REGISTRO.NIF_OFICIAL);
DBMS_OUTPUT.PUT_LINE ('SUELDO: ' || REGISTRO.SUELDO);
DBMS_OUTPUT.PUT_LINE (' ---- ');
EXCEPTION
WHEN NO_DATA_FOUND THEN
DBMS_OUTPUT.PUT_LINE ('NO SE HA ENCONTRADO EL DNI DEL PEON');
END VERPEON;
/



CREATE OR REPLACE FUNCTION JEFE_NIF (NIF_JEFE VARCHAR2) 
RETURN VARCHAR2 IS
CURSOR CEMPLEADO IS
SELECT * FROM JEFE WHERE NIF_JEFE LIKE NIF;
REGISTRO CEMPLEADO%ROWTYPE;
BEGIN
OPEN CEMPLEADO;
LOOP
FETCH CEMPLEADO INTO REGISTRO;
EXIT WHEN CEMPLEADO%NOTFOUND;
END LOOP;
CLOSE CEMPLEADO;
RETURN REGISTRO.NOMBRE;
END JEFE_NIF ;
/


CREATE OR REPLACE FUNCTION OBRA_COD (COD_OBRA VARCHAR2) 
RETURN VARCHAR2 IS
CURSOR CEMPLEADO IS
SELECT DESCRIPCION FROM OBRA WHERE COD_OBRA LIKE COD;
REGISTRO CEMPLEADO%ROWTYPE;
BEGIN
OPEN CEMPLEADO;
LOOP
FETCH CEMPLEADO INTO REGISTRO;
EXIT WHEN CEMPLEADO%NOTFOUND;
END LOOP;
CLOSE CEMPLEADO;
RETURN REGISTRO.DESCRIPCION;
END OBRA_COD ;
/


CREATE OR REPLACE FUNCTION CLIENTE_NIF (NIF_CLIENTE VARCHAR2) 
RETURN VARCHAR2 IS
CURSOR CEMPLEADO IS
SELECT NOMBRE FROM CLIENTE WHERE NIF_CLIENTE LIKE NIF;
REGISTRO CEMPLEADO%ROWTYPE;
BEGIN
OPEN CEMPLEADO;
LOOP
FETCH CEMPLEADO INTO REGISTRO;
EXIT WHEN CEMPLEADO%NOTFOUND;
END LOOP;
CLOSE CEMPLEADO;
RETURN REGISTRO.NOMBRE; 
END CLIENTE_NIF ;
/


DECLARE
CURSOR OFI IS
SELECT NIF FROM OFICIAL;
REGISTRO1 OFI%ROWTYPE;
CURSOR CAPA IS
SELECT NIF FROM CAPATAZ;
REGISTRO2 CAPA%ROWTYPE;
CURSOR PE IS
SELECT NIF FROM PEON;
REGISTRO3 PE%ROWTYPE;
CURSOR JEF IS
SELECT NIF FROM JEFE;
REGISTRO4 JEF%ROWTYPE;
CURSOR OB IS
SELECT COD FROM OBRA;
REGISTRO5 OB%ROWTYPE;
CURSOR  CLI IS
SELECT NIF FROM CLIENTE;
REGISTRO6 CLI%ROWTYPE;
BEGIN 
DBMS_OUTPUT.PUT_LINE ('ESTOS SON TODOS LOS OFICIALES:'); 
DBMS_OUTPUT.PUT_LINE ('    ');
OPEN OFI;
LOOP
FETCH OFI INTO REGISTRO1;
EXIT WHEN OFI%NOTFOUND;
VEROFICIAL(REGISTRO1.NIF);
END LOOP;
CLOSE OFI;
DBMS_OUTPUT.PUT_LINE ('    ');
DBMS_OUTPUT.PUT_LINE ('ESTOS SON TODOS LOS CAPATACES:'); 
DBMS_OUTPUT.PUT_LINE ('    ');
OPEN CAPA;
LOOP
FETCH CAPA INTO REGISTRO2;
EXIT WHEN CAPA%NOTFOUND;
VERCAPATAZ(REGISTRO2.NIF);
END LOOP;
CLOSE CAPA;
DBMS_OUTPUT.PUT_LINE ('    ');
DBMS_OUTPUT.PUT_LINE ('ESTOS SON TODOS LOS PEONES:'); 
DBMS_OUTPUT.PUT_LINE ('    ');
OPEN PE;
LOOP
FETCH PE INTO REGISTRO3;
EXIT WHEN PE%NOTFOUND;
VERPEON(REGISTRO3.NIF);
END LOOP;
CLOSE PE;
DBMS_OUTPUT.PUT_LINE ('    ');
DBMS_OUTPUT.PUT_LINE ('ESTOS SON TODOS LOS NOMBRES DE LOS JEFES:'); 
DBMS_OUTPUT.PUT_LINE ('    ');
OPEN JEF;
LOOP
FETCH JEF INTO REGISTRO4;
EXIT WHEN JEF%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('NIF: '||REGISTRO4.NIF );
DBMS_OUTPUT.PUT_LINE('NOMBRE: '||JEFE_NIF(REGISTRO4.NIF));
DBMS_OUTPUT.PUT_LINE('        ');
END LOOP;
CLOSE JEF;
DBMS_OUTPUT.PUT_LINE ('    ');
DBMS_OUTPUT.PUT_LINE ('ESTOS SON TODAS LAS DESCRIPCIONES DE LAS OBRAS:'); 
DBMS_OUTPUT.PUT_LINE ('    ');
OPEN OB;
LOOP
FETCH OB INTO REGISTRO5;
EXIT WHEN OB%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('COD: '||REGISTRO5.COD );
DBMS_OUTPUT.PUT_LINE('DESCRIPCION: '||OBRA_COD(REGISTRO5.COD));
DBMS_OUTPUT.PUT_LINE('        ');
END LOOP;
CLOSE OB;
DBMS_OUTPUT.PUT_LINE ('    ');
DBMS_OUTPUT.PUT_LINE ('ESTOS SON TODOS LOS NOMBRES DE LOS CLIENTES:'); 
DBMS_OUTPUT.PUT_LINE ('    ');
OPEN CLI;
LOOP
FETCH CLI INTO REGISTRO6;
EXIT WHEN CLI%NOTFOUND;
DBMS_OUTPUT.PUT_LINE('NIF: '||REGISTRO6.NIF );
DBMS_OUTPUT.PUT_LINE('NOMBRE: '||CLIENTE_NIF(REGISTRO6.NIF));
DBMS_OUTPUT.PUT_LINE('        ');
END LOOP;
CLOSE CLI;
END;
/
